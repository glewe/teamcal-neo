{% extends "layout.twig" %}

{% block content %}
  <!-- ====================================================================
      view.groupcalendaredit
      -->
  <div class="container content" style="padding-left: 4px; padding-right: 4px;">

    {% if showAlert and (showAlerts != 'none') %}
      {% if (showAlerts == 'all') or (showAlerts == 'warnings' and (alertData.type == 'warning' or alertData.type == 'danger')) %}
        {{ createAlertBox(alertData)|raw }}
      {% endif %}
    {% endif %}

    {{ resetTabindex() }}
    {% set colsleft = 1 %}
    {% set colsright = 4 %}
    {% set currDate = "now"|date("Y-m-d") %}

    <form class="form-control-horizontal" enctype="multipart/form-data" action="index.php?action={{ controller }}&amp;month={{ year ~ month }}&amp;region={{ regionid }}&amp;group={{ groupid }}" method="post" target="_self" accept-charset="utf-8">
      <input name="csrf_token" type="hidden" value="{{ csrf_token }}">
      <input name="hidden_month" type="hidden" class="text" value="{{ month }}">
      <input name="hidden_region" type="hidden" class="text" value="{{ regionid }}">

      {% set pageBwdYear = year %}
      {% set pageBwdMonth = month %}
      {% set pageFwdYear = year %}
      {% set pageFwdMonth = month %}

      {% if month == 1 %}
        {% set pageBwdYear = year - 1 %}
        {% set pageBwdMonth = '12' %}
        {% set pageFwdYear = year %}
        {% set pageFwdMonth = '%02d'|format(month + 1) %}
      {% elseif month == 12 %}
        {% set pageBwdYear = year %}
        {% set pageBwdMonth = '%02d'|format(month - 1) %}
        {% set pageFwdYear = year + 1 %}
        {% set pageFwdMonth = '01' %}
      {% else %}
        {% set pageBwdYear = year %}
        {% set pageFwdYear = year %}
        {% set pageBwdMonth = '%02d'|format(month - 1) %}
        {% set pageFwdMonth = '%02d'|format(month + 1) %}
      {% endif %}

      <div class="page-menu">
        <a class="btn btn-secondary" href="index.php?action={{ controller }}&amp;month={{ pageBwdYear ~ pageBwdMonth }}&amp;region={{ regionid }}&amp;group={{ groupid }}">
          <span class="fas fa-angle-double-left"></span>
        </a>
        <a class="btn btn-secondary" href="index.php?action={{ controller }}&amp;month={{ pageFwdYear ~ pageFwdMonth }}&amp;region={{ regionid }}&amp;group={{ groupid }}">
          <span class="fas fa-angle-double-right"></span>
        </a>
        <a class="btn btn-secondary" href="index.php?action={{ controller }}&amp;month={{ yearToday ~ monthToday }}&amp;region={{ regionid }}&amp;group={{ groupid }}">{{ LANG.today }}</a>
        <button type="button" class="btn btn-primary" tabindex="{{ nextTabindex() }}" data-bs-toggle="modal" data-bs-target="#modalPattern">{{ LANG.caledit_Pattern }}</button>
        <button type="button" class="btn btn-primary" tabindex="{{ nextTabindex() }}" data-bs-toggle="modal" data-bs-target="#modalPeriod">{{ LANG.caledit_Period }}</button>
        <button type="button" class="btn btn-primary" tabindex="{{ nextTabindex() }}" data-bs-toggle="modal" data-bs-target="#modalRecurring">{{ LANG.caledit_Recurring }}</button>
        <button type="button" class="btn btn-warning" tabindex="{{ nextTabindex() }}" data-bs-toggle="modal" data-bs-target="#modalSelectRegion">{{ LANG.region ~ ': ' ~ regionname }}</button>
        <button type="button" class="btn btn-success" tabindex="{{ nextTabindex() }}" data-bs-toggle="modal" data-bs-target="#modalSelectGroup">{{ LANG.group ~ ': ' ~ groupname }}</button>
        <button type="button" class="btn btn-primary" tabindex="{{ nextTabindex() }}" data-bs-toggle="modal" data-bs-target="#modalSave">{{ LANG.btn_save }}</button>
        <button type="button" class="btn btn-danger" tabindex="{{ nextTabindex() }}" data-bs-toggle="modal" data-bs-target="#modalClearAll">{{ LANG.btn_clear_all }}</button>
        {% if supportMobile %}
          <button type="button" class="btn btn-secondary" tabindex="{{ nextTabindex() }}" data-bs-toggle="modal" data-bs-target="#modalSelectWidth">{{ LANG.screen ~ ': ' ~ width }}</button>
        {% endif %}
      </div>

      <div class="card">
        {% set pageHelpLink = '' %}
        {% if pageHelp %}
          {% set pageHelpLink = '<a href="' ~ CONF.controllers[controller].docurl ~ '" target="_blank" class="float-end" style="color:inherit;"><i class="bi bi-question-circle-fill bi-lg"></i></a>' %}
        {% endif %}
        <div class="card-header text-bg-{{ CONF.controllers[controller].panelColor }}">{{ LANG.caledit_title|format(year, month, LANG.group ~ ': ' ~ groupname) }}{{ pageHelpLink|raw }}</div>
      </div>
      <div style="height:20px;"></div>

      {% set mobilecols = {} %}
      {% if not supportMobile %}
        {% set mobilecols = { 'full': dateInfo.daysInMonth } %}
      {% else %}
        {% if width == '1024plus' %}
          {% set mobilecols = { 'full': dateInfo.daysInMonth } %}
        {% elseif width == '1024' %}
          {% set mobilecols = { '1024': 25 } %}
        {% elseif width == '800' %}
          {% set mobilecols = { '800': 17 } %}
        {% elseif width == '640' %}
          {% set mobilecols = { '640': 14 } %}
        {% elseif width == '480' %}
          {% set mobilecols = { '480': 9 } %}
        {% elseif width == '400' %}
          {% set mobilecols = { '400': 7 } %}
        {% elseif width == '320' %}
          {% set mobilecols = { '320': 5 } %}
        {% elseif width == '240' %}
          {% set mobilecols = { '240': 3 } %}
        {% else %}
          {% set mobilecols = { 'full': dateInfo.daysInMonth } %}
        {% endif %}
      {% endif %}

      {% for key, cols in mobilecols %}
        {% set days = dateInfo.daysInMonth %}
        {% set tables = (days / cols)|round(0, 'ceil') %}
        {% for t in 0..(tables - 1) %}
          {% set daystart = (t * cols) + 1 %}
          {% set daysleft = days - (cols * t) %}
          {% set dayend = (daysleft >= cols) ? (daystart + cols - 1) : days %}

          <div class="table{{ supportMobile ? key : '' }}">
            <table class="table table-bordered month">
              <thead>
                <!-- Row: Month name and day numbers -->
                <tr>
                  <th class="m-monthname" scope="col">{{ dateInfo.monthname }}
                    {{ dateInfo.year }}</th>
                  {% for i in daystart..dayend %}
                    <th class="m-daynumber text-center" scope="col" {{ dayStyles[i]|raw }}>{{ i }}</th>
                  {% endfor %}
                </tr>

                <!-- Row: Weekdays -->
                <tr>
                  <th class="m-label" scope="row">&nbsp;</th>
                  {% for i in daystart..dayend %}
                    {% set wdayProp = 'wday' ~ i %}
                    <th class="m-weekday text-center" scope="col" {{ dayStyles[i]|raw }}>{{ LANG.weekdayShort[M[wdayProp]] }}</th>
                  {% endfor %}
                </tr>

                {% if showWeekNumbers %}
                  <!-- Row: Week numbers -->
                  <tr>
                    <th class="m-label" scope="row">{{ LANG.weeknumber }}</th>
                    {% for i in daystart..dayend %}
                      {% set weekProp = 'week' ~ i %}
                      {% set wdayProp = 'wday' ~ i %}
                      <th class="m-weeknumber text-center{{ (M[wdayProp] == firstDayOfWeek) ? ' first' : ' inner' }}" scope="col">{{ (M[wdayProp] == firstDayOfWeek) ? M[weekProp] : '' }}</th>
                    {% endfor %}
                  </tr>
                {% endif %}

              </thead>
              <tbody>

                <!-- Rows: Current absence -->
                <tr>
                  <td class="m-label">{{ LANG.caledit_currentAbsence }}</td>
                  {% for i in daystart..dayend %}
                    {% set style = dayStyles[i]|raw %}
                    {% set icon = '' %}
                    {% set abs = T.getAbsence(groupusername, year, month, i) %}
                    {% if abs %}
                      {% set style = ' style="color: #' ~ A.getColor(abs) ~ '; background-color: #' ~ A.getBgColor(abs) ~ ';' %}
                      {% if allConfig.symbolAsIcon %}
                        {% set icon = A.getSymbol(abs) %}
                      {% else %}
                        {% set icon = '<span class="' ~ A.getIcon(abs) ~ '"></span>' %}
                      {% endif %}
                      {% set loopDate = year ~ '-' ~ month ~ '-' ~ "%02d"|format(i) %}
                      {% if loopDate == currDate %}
                        {% set style = style ~ 'border-left: ' ~ allConfig.todayBorderSize ~ 'px solid #' ~ allConfig.todayBorderColor ~ ';border-right: ' ~ allConfig.todayBorderSize ~ 'px solid #' ~ allConfig.todayBorderColor ~ ';' %}
                      {% endif %}
                      {% set style = style ~ '"' %}
                    {% endif %}
                    <td class="m-day text-center" {{ style|raw }}>{{ icon|raw }}</td>
                  {% endfor %}
                </tr>

                <!-- Rows ff: Absences -->
                {% for abs in absences %}
                  {% if (not abs.manager_only) or (abs.manager_only and (UG.isGroupManagerOfGroup(UL.username, groupid) or UL.username == 'admin')) %}
                    <tr>
                      <td class="m-name">{{ abs.name }}</td>
                      {% for i in daystart..dayend %}
                        {% set absProp = 'abs' ~ i %}
                        <td class="m-day text-center" {{ dayStyles[i]|raw }}><input class="form-check-input" name="opt_abs_{{ i }}" type="radio" value="{{ abs.id }}" {{ (T[absProp] == abs.id) ? ' checked' : '' }}></td>
                      {% endfor %}
                    </tr>
                  {% endif %}
                {% endfor %}

                <!-- Last Row: Clear radio button -->
                <tr>
                  <td class="m-label">{{ LANG.caledit_clearAbsence }}</td>
                  {% for i in daystart..dayend %}
                    <td class="m-label text-center"><input class="form-check-input" name="opt_abs_{{ i }}" type="radio" value="0"></td>
                  {% endfor %}
                </tr>
              </tbody>
            </table>
          </div>

        {% endfor %}
      {% endfor %}

      <!-- Modal: Save -->
      {{ createModalTop('modalSave', LANG.modal_confirm) }}
      {{ LANG.caledit_confirm_savegroup|format(year, month, groupname)|raw }}
      <div class="form-check">
        <label><input class="form-check-input" type="checkbox" name="chk_keepExisting" tabindex="{{ nextTabindex() }}" checked>{{ LANG.caledit_keepExisting }}</label>
      </div>
      {{ createModalBottom('btn_save', 'primary', LANG.btn_save) }}

      <!-- Modal: Clear All -->
      {{ createModalTop('modalClearAll', LANG.modal_confirm) }}
      {{ LANG.caledit_confirm_clearall|format(year, month, LANG.group ~ ': ' ~ groupname)|raw }}
      {{ createModalBottom('btn_clearall', 'success', LANG.btn_clear_all) }}

      <!-- Modal: Select Region -->
      {{ createModalTop('modalSelectRegion', LANG.cal_selRegion) }}
      <select id="region" class="form-select" name="sel_region" tabindex="{{ nextTabindex() }}">
        {% for reg in regions %}
          <option value="{{ reg.id }}" {{ (regionid == reg.id) ? 'selected="selected"' : '' }}>{{ reg.name }}</option>
        {% endfor %}
      </select>
      {{ createModalBottom('btn_region', 'success', LANG.btn_select) }}

      <!-- Modal: Screen Width -->
      {{ createModalTop('modalSelectWidth', LANG.cal_selWidth) }}
      <p>{{ LANG.cal_selWidth_comment }}</p>
      <select id="width" class="form-select" name="sel_width" tabindex="{{ nextTabindex() }}">
        {% for key, value in LANG.widths %}
          <option value="{{ key }}" {{ (width == key) ? ' selected="selected"' : '' }}>{{ value }}</option>
        {% endfor %}
      </select>
      {{ createModalBottom('btn_width', 'warning', LANG.btn_select) }}

      <!-- Modal: Select Group -->
      {{ createModalTop('modalSelectGroup', LANG.caledit_selGroup) }}
      <select id="group" class="form-select" name="sel_group" tabindex="{{ nextTabindex() }}">
        {% for group in groups %}
          <option value="{{ group.id }}" {{ (groupid == group.id) ? ' selected="selected"' : '' }}>{{ group.name }}</option>
        {% endfor %}
      </select>
      {{ createModalBottom('btn_group', 'success', LANG.btn_select) }}

      <!-- Modal: Pattern -->
      {{ createModalTop('modalPattern', LANG.caledit_PatternTitle, 'lg') }}
      <div class="row">
        <div class="col-lg-7">
          <label for="absencePattern" class="text-bold">{{ LANG.caledit_absencePattern }}</label><br>
          <span class="text-normal">{{ LANG.caledit_absencePattern_comment }}</span>
        </div>
        <div class="col-lg-5">
          <select class="form-select" id="absencePattern" name="sel_absencePattern" tabindex="{{ nextTabindex() }}" onchange="showPattern(this.value)">
            {% for ptn in patterns %}
              <option value="{{ ptn.id }}">{{ ptn.name }}</option>
            {% endfor %}
          </select>
        </div>
      </div>
      <div class="mt-4">
        {% for ptn in patterns %}
          <div id="pattern-{{ ptn.id }}" class="col">
            {{ createPatternTable(ptn.id) }}
          </div>
        {% endfor %}
      </div>
      <div class="row mt-4">
        <div class="col-lg-7">
          <label for="absencePatternSkipHolidays" class="text-bold">{{ LANG.caledit_absencePatternSkipHolidays }}</label><br>
          <span class="text-normal">{{ LANG.caledit_absencePatternSkipHolidays_comment }}</span>
        </div>
        <div class="col-lg-5">
          <div class="form-check">
            <input id="absencePatternSkipHolidays" name="chk_absencePatternSkipHolidays" value="1" tabindex="{{ nextTabindex() }}" type="checkbox" class="form-check-input">
            <label class="form-check-label" for="absencePatternSkipHolidays">
              {{ LANG.caledit_absencePatternSkipHolidays }}
            </label>
          </div>
        </div>
      </div>
      {{ createModalBottom('btn_savepattern', 'success', LANG.btn_save) }}

      <!-- Modal: Period -->
      {{ createModalTop('modalPeriod', LANG.caledit_PeriodTitle) }}
      <div class="row">
        <div class="col-lg-7" style="margin-bottom: 20px;">
          <span class="text-bold">{{ LANG.caledit_absenceType }}</span><br>
          <span class="text-normal">{{ LANG.caledit_absenceType_comment }}</span>
        </div>
        <div class="col-lg-5" style="margin-bottom: 20px;">
          <select id="periodAbsence" class="form-select" name="sel_periodAbsence" tabindex="{{ nextTabindex() }}">
            {% for abs in absences %}
              <option value="{{ abs.id }}">{{ abs.name }}</option>
            {% endfor %}
          </select>
        </div>
      </div>
      <div>&nbsp;</div>
      <div class="row">
        <div class="col-lg-7" style="margin-bottom: 20px;">
          <span class="text-bold">{{ LANG.caledit_startDate }}</span><br>
          <span class="text-normal">{{ LANG.caledit_startDate_comment }}</span>
        </div>
        <div class="col-lg-5" style="margin-bottom: 20px;">
          <input id="periodStart" class="form-control" tabindex="{{ nextTabindex() }}" name="txt_periodStart" type="text" maxlength="10" value="">
        </div>
        {% if inputAlert.periodStart is defined %}
          <br>
          <div class="alert alert-dismissable alert-danger">
            <button type="button" class="btn-close float-end" data-bs-dismiss="alert"></button>
            {{ inputAlert.periodStart }}</div>
        {% endif %}
      </div>
      <div>&nbsp;</div>
      <div class="row">
        <div class="col-lg-7" style="margin-bottom: 20px;">
          <span class="text-bold">{{ LANG.caledit_endDate }}</span><br>
          <span class="text-normal">{{ LANG.caledit_endDate_comment }}</span>
        </div>
        <div class="col-lg-5" style="margin-bottom: 20px;">
          <input id="periodEnd" class="form-control" tabindex="{{ nextTabindex() }}" name="txt_periodEnd" type="text" maxlength="10" value="">
        </div>
        {% if inputAlert.periodEnd is defined %}
          <br>
          <div class="alert alert-dismissable alert-danger">
            <button type="button" class="btn-close float-end" data-bs-dismiss="alert"></button>
            {{ inputAlert.periodEnd }}</div>
        {% endif %}
      </div>
      {{ createModalBottom('btn_saveperiod', 'success', LANG.btn_save) }}

      <!-- Modal: Recurring -->
      {{ createModalTop('modalRecurring', LANG.caledit_RecurringTitle) }}
      <div class="row">
        <div class="col-lg-7" style="margin-bottom: 20px;">
          <span class="text-bold">{{ LANG.caledit_absenceType }}</span><br>
          <span class="text-normal">{{ LANG.caledit_absenceType_comment }}</span>
        </div>
        <div class="col-lg-5" style="margin-bottom: 20px;">
          <select id="recurringAbsence" class="form-select" name="sel_recurringAbsence" tabindex="{{ nextTabindex() }}">
            {% for abs in absences %}
              <option value="{{ abs.id }}">{{ abs.name }}</option>
            {% endfor %}
          </select>
        </div>
      </div>
      <div>&nbsp;</div>
      <div>
        <span class="text-bold">{{ LANG.caledit_recurrence }}</span><br>
        <span class="text-normal">{{ LANG.caledit_recurrence_comment }}</span>
      </div>
      <div>&nbsp;</div>
      <div class="row">
        <div class="col-lg-5">
          <div class="form-check"><input class="form-check-input" id="monday" name="monday" value="monday" tabindex="{{ nextTabindex() }}" type="checkbox">{{ LANG.weekdayLong[1] }}</div>
          <div class="form-check"><input class="form-check-input" id="tuesday" name="tuesday" value="tuesday" tabindex="{{ nextTabindex() }}" type="checkbox">{{ LANG.weekdayLong[2] }}</div>
          <div class="form-check"><input class="form-check-input" id="wednesday" name="wednesday" value="wednesday" tabindex="{{ nextTabindex() }}" type="checkbox">{{ LANG.weekdayLong[3] }}</div>
          <div class="form-check"><input class="form-check-input" id="thursday" name="thursday" value="thursday" tabindex="{{ nextTabindex() }}" type="checkbox">{{ LANG.weekdayLong[4] }}</div>
          <div class="form-check"><input class="form-check-input" id="friday" name="friday" value="friday" tabindex="{{ nextTabindex() }}" type="checkbox">{{ LANG.weekdayLong[5] }}</div>
        </div>
        <div class="col-lg-5">
          <div class="form-check"><input class="form-check-input" id="saturday" name="saturday" value="saturday" tabindex="{{ nextTabindex() }}" type="checkbox">{{ LANG.weekdayLong[6] }}</div>
          <div class="form-check"><input class="form-check-input" id="sunday" name="sunday" value="sunday" tabindex="{{ nextTabindex() }}" type="checkbox">{{ LANG.weekdayLong[7] }}</div>
          <div class="form-check"><input class="form-check-input" id="workdays" name="workdays" value="workdays" tabindex="{{ nextTabindex() }}" type="checkbox">Mon-Fri</div>
          <div class="form-check"><input class="form-check-input" id="weekends" name="weekends" value="weekends" tabindex="{{ nextTabindex() }}" type="checkbox">Sat-Sun</div>
        </div>
      </div>
      <div>&nbsp;</div>
      {{ createModalBottom('btn_saverecurring', 'success', LANG.btn_save) }}

    </form>

  </div>
{% endblock %}

{% block javascripts %}
  <script>
    function hideAllPatterns(){{% for ptn in patterns %}
        document.getElementById('pattern- {{ ptn.id }}').style.display = "none";{% endfor %}
    }

    function showPattern(id) {
      hideAllPatterns();
      document.getElementById('pattern-' + id).style.display = "block";
    }

    $(function () {
      $("#periodStart").datepicker({changeMonth: true, changeYear: true, dateFormat: "yy-mm-dd"});
      $("#periodEnd").datepicker({changeMonth: true, changeYear: true, dateFormat: "yy-mm-dd"});

      // Make drop downs work in modal dialogs. Needed once on page.
      if ($.fn.modal && $.fn.modal.Constructor) {
        var enforceModalFocusFn = $.fn.modal.Constructor.prototype.enforceFocus;
        $.fn.modal.Constructor.prototype.enforceFocus = function () {};
      }

      // Show first pattern on load
      {% if patterns|length > 0 %}showPattern({{ patterns[0].id }});{% endif %}
    });
  </script>
{% endblock %}
